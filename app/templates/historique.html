{% extends "base.html" %}

{% block title %}BoursA - Historique{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .test-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .test-normalite { border-left-color: #3b82f6; }
        .test-moyenne { border-left-color: #10b981; }
        .test-variance { border-left-color: #f59e0b; }
        .test-non-param { border-left-color: #8b5cf6; }
        .test-temporel { border-left-color: #ef4444; }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        
        .badge-normalite { background-color: #dbeafe; color: #1e40af; }
        .badge-moyenne { background-color: #d1fae5; color: #065f46; }
        .badge-variance { background-color: #fef3c7; color: #92400e; }
        .badge-non-param { background-color: #ede9fe; color: #5b21b6; }
        .badge-temporel { background-color: #fee2e2; color: #991b1b; }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
        }
        
        .conclusion-positif { background-color: #d1fae5; color: #065f46; }
        .conclusion-negatif { background-color: #fee2e2; color: #991b1b; }
        .conclusion-neutre { background-color: #fef3c7; color: #92400e; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            width: 80%;
            max-width: 800px;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Section principale -->
    <div class="max-w-7xl mx-auto p-6">
        <!-- En-tête de la page -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Historique des Tests Statistiques</h1>
            <a href="{{ url_for('previsions.index') }}" class="bg-amber-500 text-white px-4 py-2 rounded-full text-lg font-semibold hover:bg-amber-600 transition duration-300 shadow-lg">
                <i class="fas fa-chart-line mr-2"></i> Effectuer une Prévision
            </a>
        </div>
            <p class="text-gray-600">Visualisez, gérez et exportez tous vos tests effectués sur BoursA</p>
        </div>
        
        {% if total_tests == 0 %}
        <!-- État vide - Aucun test effectué -->
        <div class="text-center py-16 bg-white rounded-2xl shadow-lg">
            <div class="max-w-md mx-auto">
                <div class="w-24 h-24 mx-auto mb-6 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-chart-line text-blue-600 text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Aucun test dans l'historique</h2>
                <p class="text-gray-600 mb-8">Vous n'avez pas encore effectué de tests statistiques. Commencez par analyser vos données.</p>
                <div class="space-y-4">
                    <a href="{{ url_for('tests.index') }}" class="inline-block bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-semibold hover:bg-blue-700 transition">
                        <i class="fas fa-play mr-2"></i>Effectuer un premier test
                    </a>
                    <br>
                    <a href="{{ url_for('home.description') }}" class="inline-block bg-gray-200 text-gray-800 px-6 py-2 rounded-full hover:bg-gray-300 transition">
                        <i class="fas fa-book mr-2"></i>Découvrir les tests disponibles
                    </a>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- Statistiques générales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card p-6">
                <div class="flex items-center">
                    <div class="mr-4">
                        <i class="fas fa-chart-bar text-3xl opacity-80"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-90">Tests totaux</p>
                        <p class="text-2xl font-bold">{{ total_tests }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex items-center">
                    <div class="mr-4 text-green-600">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Tests significatifs</p>
                        <p class="text-2xl font-bold text-gray-800" id="significantTests">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex items-center">
                    <div class="mr-4 text-blue-600">
                        <i class="fas fa-calendar-alt text-3xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Dernier test</p>
                        <p class="text-lg font-bold text-gray-800" id="lastTestDate">{{ history[0].timestamp if history else 'N/A' }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex items-center">
                    <div class="mr-4 text-purple-600">
                        <i class="fas fa-file-csv text-3xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Fichiers analysés</p>
                        <p class="text-2xl font-bold text-gray-800" id="uniqueFiles">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Outils de gestion -->
        <div class="mb-8 bg-white rounded-xl shadow p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Gérer l'historique</h3>
                    <p class="text-gray-600 text-sm">Exportez ou nettoyez vos données de test</p>
                </div>
                
                <div class="flex flex-wrap gap-3">
                    <div class="relative group">
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                            <i class="fas fa-download mr-2"></i> Exporter
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div class="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10">
                            <a href="{{ url_for('resultats.download_history', format='json') }}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-t-lg">
                                <i class="fas fa-file-code mr-2"></i> JSON
                            </a>
                            <a href="{{ url_for('resultats.download_history', format='pdf') }}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-file-pdf mr-2 text-red-600"></i> PDF
                            </a>
                            <a href="{{ url_for('resultats.download_history', format='excel') }}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-b-lg">
                                <i class="fas fa-file-excel mr-2 text-green-600"></i> Excel
                            </a>
                        </div>
                    </div>
                    <button onclick="showClearConfirmation()" class="bg-red-100 text-red-800 px-4 py-2 rounded-lg hover:bg-red-200 transition flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i> Tout effacer
                    </button>

                    <!-- Formulaire caché pour la suppression -->
                    <form id="clearHistoryForm" method="POST" action="{{ url_for('historique.clear_all_history') }}" style="display: none;"></form>
                </div>
            </div>
            
            <!-- Filtres -->
            <div id="filtersSection" class="mt-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type de test</label>
                        <select id="filterType" class="w-full p-2 border rounded">
                            <option value="all">Tous les types</option>
                            <option value="normalite">Tests de normalité</option>
                            <option value="moyenne">Tests de moyenne</option>
                            <option value="variance">Tests de variance</option>
                            <option value="non-param">Tests non paramétriques</option>
                            <option value="temporel">Séries temporelles</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Conclusion</label>
                        <select id="filterConclusion" class="w-full p-2 border rounded">
                            <option value="all">Toutes les conclusions</option>
                            <option value="positif">Significatif</option>
                            <option value="negatif">Non significatif</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Période</label>
                        <select id="filterPeriod" class="w-full p-2 border rounded">
                            <option value="all">Toute période</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="week">Cette semaine</option>
                            <option value="month">Ce mois</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end mt-4">
                    <button onclick="applyFilters()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                        Appliquer les filtres
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Graphique de visualisation -->
        <div class="mb-8 bg-white rounded-xl shadow p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribution des tests</h3>
            <div class="h-64">
                <canvas id="testDistributionChart"></canvas>
            </div>
        </div>
        
        <!-- Liste des tests -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Tous les tests effectués</h3>
                <span class="text-gray-600" id="testCount">{{ total_tests }} tests</span>
            </div>
            
            <div class="space-y-4" id="testList">
                {% for test in history %}
                <div class="test-card bg-white rounded-xl shadow p-6 
                    {% if test.test_type == 'univarie' %} test-normalite
                    {% elif test.test_name in ['ttest_1samp', 'ttest_ind', 'welch'] %} test-moyenne
                    {% elif test.test_name in ['levene', 'bartlett', 'fligner'] %} test-variance
                    {% elif test.test_name in ['mannwhitney', 'wilcoxon', 'kruskal'] %} test-non-param
                    {% elif test.test_name in ['adf', 'kpss', 'pp'] %} test-temporel
                    {% endif %}">
                    
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <!-- Informations principales -->
                        <div class="flex-1">
                            <div class="flex items-center mb-3">
                                <h4 class="text-lg font-bold text-gray-800 mr-3">{{ test.test_name|title }}</h4>
                                <span class="badge 
                                    {% if test.test_type == 'univarie' %} badge-normalite
                                    {% elif test.test_name in ['ttest_1samp', 'ttest_ind', 'welch'] %} badge-moyenne
                                    {% elif test.test_name in ['levene', 'bartlett', 'fligner'] %} badge-variance
                                    {% elif test.test_name in ['mannwhitney', 'wilcoxon', 'kruskal'] %} badge-non-param
                                    {% elif test.test_name in ['adf', 'kpss', 'pp'] %} badge-temporel
                                    {% endif %}">
                                    {% if test.test_type == 'univarie' %} Normalité
                                    {% elif test.test_name in ['ttest_1samp', 'ttest_ind', 'welch'] %} Moyenne
                                    {% elif test.test_name in ['levene', 'bartlett', 'fligner'] %} Variance
                                    {% elif test.test_name in ['mannwhitney', 'wilcoxon', 'kruskal'] %} Non-param
                                    {% elif test.test_name in ['adf', 'kpss', 'pp'] %} Temporel
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="space-y-2 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-file-alt w-5 mr-2"></i>
                                    <span class="font-medium">Fichier:</span>
                                    <span class="ml-2">{{ test.filename }}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <i class="fas fa-columns w-5 mr-2"></i>
                                    <span class="font-medium">Colonnes:</span>
                                    <span class="ml-2">{{ test.columns_used|join(', ') }}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <i class="fas fa-calendar w-5 mr-2"></i>
                                    <span class="font-medium">Date:</span>
                                    <span class="ml-2">{{ test.timestamp }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Résultats et actions -->
                        <div class="flex flex-col justify-between items-end space-y-3">
                            <div class="text-right">
                                <p class="text-sm text-gray-500">P-Value</p>
                                <p class="text-xl font-bold text-gray-800">{{ test.p_value|round(4) }}</p>
                            </div>
                            
                            <div class="text-center">
                                <span class="badge font-semibold 
                                    {% if test.p_value < 0.05 %} conclusion-negatif
                                    {% else %} conclusion-positif
                                    {% endif %}">
                                    {% if test.p_value < 0.05 %} Rejet H0 (Significatif)
                                    {% else %} Non-rejet H0 (Non-significatif)
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button onclick="viewDetails('{{ test.id }}')" class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm hover:bg-blue-600 transition">
                                    Détails
                                </button>
                                <button onclick="deleteTest('{{ test.id }}')" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if total_pages > 1 %}
            <div class="mt-8 flex items-center justify-between bg-white px-4 py-3 rounded-lg shadow">
                <div class="flex items-center text-sm text-gray-700">
                    <span>Affichage de {{ ((page - 1) * per_page) + 1 }} à {{ [page * per_page, total_tests]|min }} sur {{ total_tests }} résultats</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <!-- Bouton Précédent -->
                    {% if has_prev %}
                    <a href="{{ url_for('historique.index', page=prev_page, per_page=per_page) }}" 
                       class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-chevron-left"></i> Précédent
                    </a>
                    {% else %}
                    <span class="px-4 py-2 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed">
                        <i class="fas fa-chevron-left"></i> Précédent
                    </span>
                    {% endif %}
                    
                    <!-- Numéros de page -->
                    <div class="flex space-x-1">
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <span class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">{{ p }}</span>
                            {% elif p <= 2 or p >= total_pages - 1 or (p >= page - 1 and p <= page + 1) %}
                            <a href="{{ url_for('historique.index', page=p, per_page=per_page) }}" 
                               class="px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-100 transition border">
                                {{ p }}
                            </a>
                            {% elif p == page - 2 or p == page + 2 %}
                            <span class="px-4 py-2 text-gray-500">...</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Bouton Suivant -->
                    {% if has_next %}
                    <a href="{{ url_for('historique.index', page=next_page, per_page=per_page) }}" 
                       class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        Suivant <i class="fas fa-chevron-right"></i>
                    </a>
                    {% else %}
                    <span class="px-4 py-2 bg-gray-100 text-gray-400 rounded-lg cursor-not-allowed">
                        Suivant <i class="fas fa-chevron-right"></i>
                    </span>
                    {% endif %}
                </div>
                
                <!-- Sélecteur d'éléments par page -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-700">Par page:</label>
                    <select onchange="window.location.href='{{ url_for('historique.index', page=1) }}&per_page=' + this.value" 
                            class="px-3 py-2 border rounded-lg">
                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <!-- Modale de détails -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-2xl font-bold text-gray-800" id="modalTitle">Détails du Test</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6" id="modalBody">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>
    
    <!-- Modale de confirmation de suppression -->
    <div id="clearModal" class="modal">
        <div class="modal-content max-w-sm">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmation de suppression</h3>
                <p class="text-gray-600 mb-6">Êtes-vous sûr de vouloir effacer tout l'historique des tests ? Cette action est irréversible.</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="closeClearModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                        Annuler
                    </button>
                    <button onclick="clearHistory()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                        Effacer tout
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialisation des données passées par Flask
        const totalTests = {{ total_tests | default(0) }};
        const history = {{ history | tojson }};
        
        // Fonction pour afficher les détails dans la modale
        function viewDetails(testId) {
            const test = history.find(t => t.id === testId);
            if (!test) return;
            
            document.getElementById('modalTitle').textContent = `Détails du Test: ${test.test_name.toUpperCase()}`;
            
            let html = `
                <div class="space-y-4">
                    <p><strong>Fichier analysé:</strong> ${test.filename}</p>
                    <p><strong>Colonnes utilisées:</strong> ${test.columns_used.join(', ')}</p>
                    <p><strong>Date d'exécution:</strong> ${test.timestamp}</p>
                    <hr>
                    <p class="text-xl font-bold">Résultats Clés</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-100 p-3 rounded">
                            <p class="text-sm text-gray-600">Statistique de Test</p>
                            <p class="text-lg font-semibold">${test.stat_value.toFixed(4)}</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded">
                            <p class="text-sm text-gray-600">P-Value</p>
                            <p class="text-lg font-semibold ${test.p_value < 0.05 ? 'text-red-600' : 'text-green-600'}">${test.p_value.toFixed(4)}</p>
                        </div>
                    </div>
                    <p class="text-xl font-bold mt-4">Interprétation</p>
                    <div class="p-4 rounded ${test.p_value < 0.05 ? 'conclusion-negatif' : 'conclusion-positif'}">
                        ${test.interpretation}
                    </div>
                    <p class="text-xl font-bold mt-4">Résultats Complets (JSON)</p>
                    <pre class="bg-gray-800 text-white p-4 rounded text-sm overflow-x-auto">${JSON.stringify(test.full_results, null, 2)}</pre>
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }
        
        // Fonction pour fermer la modale
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }
        
        // Fonctions de gestion de l'historique (à implémenter côté Flask)
        function exportHistory(format) {
            alert(`Exportation de l'historique au format ${format} (Fonctionnalité à implémenter côté serveur)`);
        }
        
        function showClearConfirmation() {
            document.getElementById('clearModal').style.display = 'block';
        }
        
        function closeClearModal() {
            document.getElementById('clearModal').style.display = 'none';
        }
        
        function clearHistory() {
            // Envoie le formulaire POST à la route /clear_history
            document.getElementById('clearHistoryForm').submit();
            closeClearModal();
        }
        
        function deleteTest(testId) {
            // Cette fonction devrait envoyer une requête au serveur pour supprimer un test
            if (confirm(`Êtes-vous sûr de vouloir supprimer le test ${testId} ?`)) {
                alert(`Suppression du test ${testId} (Fonctionnalité à implémenter côté serveur)`);
                window.location.reload();
            }
        }
        
        function filterTests() {
            const filtersSection = document.getElementById('filtersSection');
            filtersSection.classList.toggle('hidden');
        }
        
        function applyFilters() {
            alert('Application des filtres (Fonctionnalité à implémenter côté serveur)');
            // Logique de filtrage ici
        }
        
        // Initialisation du graphique (Chart.js)
        function initChart() {
            const ctx = document.getElementById('testDistributionChart').getContext('2d');
            const testCounts = {
                'Normalité': history.filter(t => t.test_type === 'univarie').length,
                'Moyenne': history.filter(t => ['ttest_1samp', 'ttest_ind', 'welch'].includes(t.test_name)).length,
                'Variance': history.filter(t => ['levene', 'bartlett', 'fligner'].includes(t.test_name)).length,
                'Non-paramétrique': history.filter(t => ['mannwhitney', 'wilcoxon', 'kruskal'].includes(t.test_name)).length,
                'Séries Temporelles': history.filter(t => ['adf', 'kpss', 'pp'].includes(t.test_name)).length,
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(testCounts),
                    datasets: [{
                        label: 'Nombre de Tests',
                        data: Object.values(testCounts),
                        backgroundColor: [
                            '#3b82f6', // blue
                            '#10b981', // green
                            '#f59e0b', // yellow
                            '#8b5cf6', // purple
                            '#ef4444', // red
                        ],
                        borderColor: [
                            '#1e40af',
                            '#065f46',
                            '#92400e',
                            '#5b21b6',
                            '#991b1b',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Exécuter l'initialisation après le chargement du DOM
        document.addEventListener('DOMContentLoaded', () => {
            if (totalTests > 0) {
                initChart();
            }
        });
    </script>
{% endblock %}
