{% extends "base.html" %}

{% block title %}BoursA - Prévisions ML{% endblock %}

{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    .step-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .step-active {
        border-left-color: #f59e0b; /* amber-500 for ML */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .table-responsive {
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <a href="{{ url_for('home.accueil') }}" class="text-blue-500 hover:text-blue-700 flex items-center mb-6">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        Retour à l'accueil
    </a>
<div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Générer une Prévision ML</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Colonne de navigation (Étapes) -->
        <div class="lg:col-span-1 space-y-4">
            <div id="step-1-card" class="step-card bg-white p-6 rounded-lg shadow step-active">
                <h2 class="text-xl font-semibold text-gray-800">Étape 1: Importation des Données</h2>
                <p class="text-sm text-gray-500">Téléchargez votre fichier CSV ou Excel.</p>
            </div>
            <div id="step-2-card" class="step-card bg-white p-6 rounded-lg shadow opacity-50">
                <h2 class="text-xl font-semibold text-gray-800">Étape 2: Sélection du Modèle et des Paramètres</h2>
                <p class="text-sm text-gray-500">Choisissez le modèle et configurez la prévision.</p>
            </div>
            <div id="step-3-card" class="step-card bg-white p-6 rounded-lg shadow opacity-50">
                <h2 class="text-xl font-semibold text-gray-800">Étape 3: Résultats de la Prévision</h2>
                <p class="text-sm text-gray-500">Visualisez le graphique et le tableau des résultats.</p>
            </div>
        </div>

        <!-- Colonne de contenu (Formulaires) -->
        <div class="lg:col-span-2">
            <!-- Étape 1: Importation des Données -->
            <div id="step-1-content" class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">1. Choisir le mode d'import</h2>

                <div class="mb-6 flex flex-col gap-3">
                    <button id="choose-local" type="button" class="w-full px-5 py-4 border-2 rounded-lg font-semibold bg-white hover:bg-amber-50 focus:ring-2 focus:ring-amber-500 text-left shadow-sm flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-amber-100 text-amber-700 font-bold">A</span>
                        <div>
                            <div class="text-lg">Importer un fichier local</div>
                            <div class="text-sm text-gray-500">CSV / Excel depuis votre ordinateur</div>
                        </div>
                    </button>
                    <button id="choose-api" type="button" class="w-full px-5 py-4 border-2 rounded-lg font-semibold bg-white hover:bg-blue-50 focus:ring-2 focus:ring-blue-500 text-left shadow-sm flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-700 font-bold">B</span>
                        <div>
                            <div class="text-lg">Importer via API boursière</div>
                            <div class="text-sm text-gray-500">Yahoo Finance ou Alpha Vantage</div>
                        </div>
                    </button>
                </div>

                <div id="import-local-panel" class="p-4 border rounded-lg bg-gray-50 hidden">
                    <p class="font-semibold mb-2">Option : Fichier local</p>
                    <form id="upload-form" method="POST" action="{{ url_for('upload.upload_file') }}" enctype="multipart/form-data">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="data_file">
                            Fichier (CSV / Excel)
                        </label>
                        <input type="file" name="data_file" id="data_file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                               class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-3">
                        <button type="submit" class="bg-amber-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-amber-700 transition w-full">
                            Charger & Analyser
                        </button>
                    </form>
                </div>

                <div id="import-api-panel" class="p-4 border rounded-lg bg-gray-50 hidden">
                    <p class="font-semibold mb-2">Option : API boursière</p>
                    <form id="api-fetch-form">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_source">Source</label>
                        <select id="api_source" name="source" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-3">
                            <option value="">Choisir...</option>
                            <option value="yahoo">Yahoo Finance (gratuit, pas de clé requise)</option>
                            <option value="alpha_vantage">Alpha Vantage (gratuit, clé requise)</option>
                            <option value="iex_cloud">IEX Cloud (gratuit, clé requise)</option>
                        </select>

                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_symbol">Ticker (ex: AAPL, BTC-USD)</label>
                        <input type="text" id="api_symbol" name="symbol" placeholder="AAPL" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-3">

                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_interval">Intervalle</label>
                        <select id="api_interval" name="interval" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-3">
                            <option value="">Par défaut</option>
                        </select>

                        <label class="block text-gray-700 text-sm font-bold mb-2" for="api_key">Clé API (Alpha Vantage / IEX Cloud)</label>
                        <input type="text" id="api_key" name="api_key" placeholder="Optionnel si la clé est définie dans .env" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4">

                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition w-full">
                            Importer via API
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Yahoo: 1d/1h/5m/1wk/1mo. Alpha Vantage: daily/weekly/monthly. IEX Cloud: 1d/1w/1mo.</p>
                    </form>
                </div>
            </div>

            <!-- Étape 2: Sélection du Modèle et des Paramètres (Initialement caché) -->
            <div id="step-2-content" class="bg-white p-8 rounded-lg shadow-xl mt-8 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">2. Sélectionner le Modèle et les Paramètres</h2>
                
                <!-- Affichage des données -->
                <div class="mb-6 p-4 bg-gray-50 border rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">Aperçu des données (<span id="filename-display"></span>)</h3>
                    <p class="text-sm text-gray-600 mb-2">Colonnes détectées : <span id="columns-list" class="font-mono text-xs bg-gray-200 p-1 rounded"></span></p>
                    <div class="table-responsive">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr id="data-header"></tr>
                            </thead>
                            <tbody id="data-preview" class="bg-white divide-y divide-gray-200">
                                <!-- Les 5 premières lignes seront insérées ici -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <form id="forecast-form" method="POST" action="{{ url_for('previsions.index') }}">
                    <div class="form-grid grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <!-- Modèle -->
                        <div class="form-group">
                            <label for="selected_model" class="block text-gray-700 text-sm font-bold mb-2">Modèle de Prévision :</label>
                            <select class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500" id="selected_model" name="selected_model" required>
                                {% for filename, description in available_models.items() %}
                                    <option value="{{ filename }}">{{ description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Colonne Cible -->
                        <div class="form-group">
                            <label for="target_column" class="block text-gray-700 text-sm font-bold mb-2">Colonne Cible :</label>
                            <select class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500" id="target_column" name="target_column" required>
                                <!-- Options de colonnes insérées par JS -->
                            </select>
                        </div>
                        
                        <!-- Type de Résultat -->
                        <div class="form-group">
                            <label for="forecast_type" class="block text-gray-700 text-sm font-bold mb-2">Type de Résultat :</label>
                            <select class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500" id="forecast_type" name="forecast_type" required>
                                <option value="close_price" selected>Valeur Prédite</option>
                                <option value="close_diff">Variation Prédite</option>
                            </select>
                        </div>
                        
                        <!-- Intervalle de Prévision -->
                        <div class="form-group">
                            <label for="forecast_interval" class="block text-gray-700 text-sm font-bold mb-2">Intervalle de Prévision :</label>
                            <select class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500" id="forecast_interval" name="forecast_interval" required>
                                <option value="jour" selected>Jour</option>
                                <option value="semaine">Semaine</option>
                                <option value="mois">Mois</option>
                                <option value="heure">Heure</option>
                            </select>
                        </div>

                        <!-- Nombre de périodes -->
                        <div class="form-group">
                            <label for="forecast_steps" class="block text-gray-700 text-sm font-bold mb-2">Nombre de périodes :</label>
                            <input type="number" class="w-full px-3 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-amber-500" id="forecast_steps" name="forecast_steps" value="5" min="1" max="30" required>
                        </div>
                        
                        <!-- Intervalle (fixé pour l'instant) -->
                        
                    </div>
                    
                    <input type="hidden" name="filename" id="forecast-filename-input">

                    <button type="button" id="back-to-step-1" class="bg-gray-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-gray-600 transition mt-6 mr-4">Retour</button>
                    <button type="submit" id="run-forecast-button" class="bg-amber-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-amber-700 transition mt-6" disabled>
                        Lancer la Prévision
                    </button>
                </form>
            </div>
            
            <!-- Étape 3: Résultats de la Prévision (Affiché après POST) -->
            <div id="step-3-content" class="bg-white p-8 rounded-lg shadow-xl mt-8 {% if not forecast_results and not forecast_plot %}hidden{% endif %}">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">3. Résultats de la Prévision</h2>
                
                {% if forecast_results and 'alert-danger' in forecast_results %}
                    <div class="alert alert-danger p-4 bg-red-100 text-red-700 rounded-lg">{{ forecast_results | safe }}</div>
                {% else %}
                    {% if forecast_plot %}
                    <div class="graph-container mb-6 p-4 border rounded-lg">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Graphique des Prévisions</h3>
                        <img src="data:image/png;base64,{{ forecast_plot }}" class="mx-auto max-w-full h-auto rounded" alt="Graphique des prévisions">
                    </div>
                    {% endif %}
                    
                    {% if forecast_results %}
                    <div class="table-responsive">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Tableau des Prévisions</h3>
                        {{ forecast_results | safe }}
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script id="previsions-bootstrap" type="application/json">
{{ {
    "columns": file_columns,
    "filename": current_file or "",
    "dtypes": file_dtypes,
    "is_post_request": True if forecast_results or forecast_plot else False,
    "require_mapping_approval": (require_mapping_approval | default(False))
} | tojson }}
</script>

<script>
    // État global de l'application
    const bootstrap = JSON.parse(document.getElementById('previsions-bootstrap').textContent || '{}');
    let global_columns = bootstrap.columns || [];
    let global_filename = bootstrap.filename || '';
    let global_dtypes = bootstrap.dtypes || {};
    let is_post_request = Boolean(bootstrap.is_post_request);
    let importMode = null;

    // Fonction pour mettre à jour l'interface en fonction de l'étape
    function updateStep(step) {
        // Mettre à jour les cartes d'étape
        const activeColor = 'step-active';
        const inactiveClass = 'opacity-50';

        $('#step-1-card').removeClass(activeColor + ' ' + inactiveClass).addClass(step === 1 ? activeColor : inactiveClass);
        $('#step-2-card').removeClass(activeColor + ' ' + inactiveClass).addClass(step === 2 ? activeColor : inactiveClass);
        $('#step-3-card').removeClass(activeColor + ' ' + inactiveClass).addClass(step === 3 ? activeColor : inactiveClass);

        // Afficher/Masquer le contenu
        $('#step-1-content').toggle(step === 1);
        $('#step-2-content').toggle(step === 2);
        $('#step-3-content').toggle(step === 3);
    }

    function selectImportMode(mode) {
        importMode = mode;
        $('#import-local-panel').toggle(mode === 'local');
        $('#import-api-panel').toggle(mode === 'api');

        // Gérer les champs required en fonction du mode
        $('#data_file').prop('required', mode === 'local');
        $('#api_source, #api_symbol').prop('required', mode === 'api');

        // Styles visuels
        $('#choose-local').toggleClass('bg-amber-50 border-amber-400', mode === 'local');
        $('#choose-api').toggleClass('bg-blue-50 border-blue-400', mode === 'api');
    }

    $('#choose-local').on('click', function() { selectImportMode('local'); });
    $('#choose-api').on('click', function() { selectImportMode('api'); });

    // Fonction pour générer les options de la colonne cible
    function generateTargetColumnOptions(columns) {
        let optionsHtml = '';
        columns.forEach(col => {
            // Tente de sélectionner 'Close' par défaut si elle existe
            const isSelected = col === 'Close';
            optionsHtml += `<option value="${col}" ${isSelected ? 'selected' : ''}>${col}</option>`;
        });
        $('#target_column').html(optionsHtml);
    }

    function hydrateDataPreview(response) {
        global_columns = response.columns;
        global_filename = response.filename;
        global_dtypes = response.dtypes;

        $('#filename-display').text(global_filename);
        
        let columnsListHtml = '';
        global_columns.forEach(col => {
            const dtype = global_dtypes[col] || 'inconnu';
            columnsListHtml += `<span class="font-mono text-xs bg-gray-200 p-1 rounded mr-2">${col} (${dtype})</span>`;
        });
        $('#columns-list').html(columnsListHtml);
        
        let headerHtml = '<tr>';
        global_columns.forEach(col => {
            headerHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`;
        });
        headerHtml += '</tr>';
        $('#data-header').html(headerHtml);

        let bodyHtml = '';
        response.preview.forEach(row => {
            bodyHtml += '<tr>';
            row.forEach(cell => {
                bodyHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cell}</td>`;
            });
            bodyHtml += '</tr>';
        });
        $('#data-preview').html(bodyHtml);

        generateTargetColumnOptions(global_columns);
        
        // Mettre à jour le champ caché du nom de fichier
        $('#forecast-filename-input').val(global_filename);
        
        // Activer le bouton de prévision
        $('#run-forecast-button').prop('disabled', false).text('Lancer la Prévision');

        // Passer à l'étape 2
        updateStep(2);
    }

    // Gestion upload local
    $('#upload-form').on('submit', function(e) {
        e.preventDefault();
        if (importMode !== 'local') {
            alert('Choisissez d\'abord le mode "Fichier local".');
            return;
        }
        const formData = new FormData(this);
        const button = $('#upload-form button[type="submit"]');
        button.prop('disabled', true).text('Analyse en cours...');

        $.ajax({
            url: '{{ url_for("upload.upload_file") }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                button.prop('disabled', false).text('Charger & Analyser');
                if (response.success) {
                    hydrateDataPreview(response);
                } else {
                    alert('Erreur lors de l\'analyse du fichier: ' + (response.message || ''));
                }
            },
            error: function(xhr) {
                button.prop('disabled', false).text('Charger & Analyser');
                alert('Une erreur est survenue lors de l\'upload: ' + xhr.responseText);
            }
        });
    });

    // Gestion import API
    $('#api_source').on('change', function() {
        const source = $(this).val();
        let options = '<option value=\"\">Par défaut</option>';
        if (source === 'yahoo') {
            options += '<option value=\"1d\">1d</option><option value=\"1h\">1h</option><option value=\"5m\">5m</option><option value=\"1wk\">1wk</option><option value=\"1mo\">1mo</option>';
        } else if (source === 'alpha_vantage') {
            options += '<option value=\"daily\">daily</option><option value=\"weekly\">weekly</option><option value=\"monthly\">monthly</option>';
        } else if (source === 'iex_cloud') {
            options += '<option value=\"1d\">1d (quotidien)</option><option value=\"1w\">1w (hebdomadaire)</option><option value=\"1mo\">1mo (mensuel)</option>';
        }
        $('#api_interval').html(options);
    });

    $('#api-fetch-form').on('submit', function(e) {
        e.preventDefault();
        if (!importMode) {
            alert('Choisissez un mode d\'import avant de continuer.');
            return;
        }
        if (importMode !== 'api') {
            alert('Sélectionnez le mode "API boursière" pour cette action.');
            return;
        }
        const button = $('#api-fetch-form button[type=\"submit\"]');
        button.prop('disabled', true).text('Import en cours...');

        const payload = {
            source: $('#api_source').val(),
            symbol: $('#api_symbol').val(),
            interval: $('#api_interval').val(),
            api_key: $('#api_key').val()
        };

        $.ajax({
            url: '{{ url_for("upload.api_fetch") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                button.prop('disabled', false).text('Importer via API');
                if (response.success) {
                    hydrateDataPreview(response);
                } else {
                    alert(response.message || 'Erreur lors de l\'import API.');
                }
            },
            error: function() {
                button.prop('disabled', false).text('Importer via API');
                alert('Erreur lors de l\'import API. Veuillez réessayer.');
            }
        });
    });

    // Gestion de la soumission du formulaire de prévision (via AJAX)
    $('#forecast-form').on('submit', function(e) {
        e.preventDefault(); // Empêcher soumission HTML classique
        
        // Mettre à jour le champ caché du nom de fichier juste avant la soumission
        $('#forecast-filename-input').val(global_filename);
        
        // Récupérer les données du formulaire
        const formData = new FormData(this);
        formData.append('ajax', 'true'); // Indicate this is an AJAX request
        const button = $('#run-forecast-button');
        button.prop('disabled', true).text('Prévision en cours...');
        
        // Soumettre via AJAX
        $.ajax({
            url: '{{ url_for("previsions.index") }}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function(response) {
                button.prop('disabled', false).text('Lancer la Prévision');
                
                if (response.success) {
                    // Injecter le graphique
                    if (response.forecast_plot) {
                        let graphContainer = $('#step-3-content .graph-container');
                        if (graphContainer.length === 0) {
                            $('#step-3-content').prepend(
                                '<div class="graph-container mb-6 p-4 border rounded-lg">' +
                                '<h3 class="text-xl font-semibold mb-3 text-gray-800">Graphique des Prévisions</h3>' +
                                '</div>'
                            );
                            graphContainer = $('#step-3-content .graph-container');
                        }
                        graphContainer.append(
                            '<img src="data:image/png;base64,' + response.forecast_plot + '" ' +
                            'class="mx-auto max-w-full h-auto rounded" alt="Graphique des prévisions">'
                        );
                    }
                    
                    // Injecter le tableau
                    if (response.forecast_results) {
                        let tableContainer = $('#step-3-content .table-responsive');
                        if (tableContainer.length === 0) {
                            $('#step-3-content').append(
                                '<div class="table-responsive mt-6">' +
                                '<h3 class="text-xl font-semibold mb-3 text-gray-800">Tableau des Prévisions</h3>' +
                                '</div>'
                            );
                            tableContainer = $('#step-3-content .table-responsive');
                        }
                        tableContainer.append(response.forecast_results);
                    }
                    
                    // Aller à l'étape 3 pour afficher les résultats
                    updateStep(3);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('Erreur: ' + (response.message || 'La prévision a échoué'));
                }
            },
            error: function(xhr, status, error) {
                button.prop('disabled', false).text('Lancer la Prévision');
                console.error('AJAX error:', error, xhr.responseText);
                alert('Une erreur est survenue: ' + (xhr.responseJSON?.message || error));
            }
        });
    });

    // Gestion du bouton "Retour"
    $('#back-to-step-1').on('click', function() {
        updateStep(1);
    });

    // Fonction pour initialiser l'étape
    function initializeStep() {
        // Toujours démarrer à l'étape 1 pour que le choix d'import soit vu en premier
        updateStep(1);

        // Pré-remplir les données si déjà en session, mais sans changer l'étape
        if (global_filename && global_columns.length > 0) {
            $('#filename-display').text(global_filename);

            let columnsListHtml = '';
            global_columns.forEach(col => {
                const dtype = global_dtypes[col] || 'inconnu';
                columnsListHtml += `<span class="font-mono text-xs bg-gray-200 p-1 rounded mr-2">${col} (${dtype})</span>`;
            });
            $('#columns-list').html(columnsListHtml);

            let headerHtml = '<tr>';
            global_columns.forEach(col => {
                headerHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`;
            });
            headerHtml += '</tr>';
            $('#data-header').html(headerHtml);

            generateTargetColumnOptions(global_columns);
            $('#forecast-filename-input').val(global_filename);
            $('#run-forecast-button').prop('disabled', false).text('Lancer la Prévision');
        }
    }

    // Initialisation de l'étape
    $(document).ready(function() {
        initializeStep();
        window.scrollTo({ top: 0, behavior: 'smooth' });

    });
</script>
{% endblock %}
